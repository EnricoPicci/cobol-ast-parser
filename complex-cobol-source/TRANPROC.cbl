       IDENTIFICATION DIVISION.
       PROGRAM-ID. TRANPROC.
      *================================================================*
      * TRANSACTION PROCESSING PROGRAM
      * Processes different transaction types using REDEFINES
      *================================================================*

       ENVIRONMENT DIVISION.
       INPUT-OUTPUT SECTION.
       FILE-CONTROL.
           SELECT TRANSACTION-FILE ASSIGN TO 'TRANFILE'
               ORGANIZATION IS SEQUENTIAL
               FILE STATUS IS WS-TRAN-STATUS.
           SELECT CUSTOMER-FILE ASSIGN TO 'CUSTFILE'
               ORGANIZATION IS INDEXED
               ACCESS MODE IS RANDOM
               RECORD KEY IS CUST-KEY
               FILE STATUS IS WS-CUST-STATUS.
           SELECT REPORT-FILE ASSIGN TO 'RPTFILE'
               FILE STATUS IS WS-RPT-STATUS.

       DATA DIVISION.
       FILE SECTION.

       FD  TRANSACTION-FILE.
           COPY TRANREC.

       FD  CUSTOMER-FILE.
           COPY CUSTREC.

       FD  REPORT-FILE.
       01  REPORT-LINE                     PIC X(132).

       WORKING-STORAGE SECTION.

       01  WS-FILE-STATUSES.
           05  WS-TRAN-STATUS              PIC XX.
           05  WS-CUST-STATUS              PIC XX.
           05  WS-RPT-STATUS               PIC XX.

       01  WS-WORK-TRANSACTION.
           COPY TRANREC.

       01  WS-WORK-CUSTOMER.
           COPY CUSTREC.

           COPY RPTFLDS.

       01  WS-TOTALS.
           05  WS-TOTAL-PAYMENTS           PIC S9(11)V99 VALUE 0.
           05  WS-TOTAL-PURCHASES          PIC S9(11)V99 VALUE 0.
           05  WS-TOTAL-REFUNDS            PIC S9(11)V99 VALUE 0.
           05  WS-TOTAL-ADJUSTMENTS        PIC S9(11)V99 VALUE 0.

       01  WS-COUNTS.
           05  WS-PAYMENT-COUNT            PIC 9(7) VALUE 0.
           05  WS-PURCHASE-COUNT           PIC 9(7) VALUE 0.
           05  WS-REFUND-COUNT             PIC 9(7) VALUE 0.
           05  WS-ADJUSTMENT-COUNT         PIC 9(7) VALUE 0.
           05  WS-ERROR-COUNT              PIC 9(7) VALUE 0.

       01  WS-WORK-FIELDS.
           05  WS-CALC-TAX                 PIC S9(7)V99.
           05  WS-CALC-TOTAL               PIC S9(9)V99.
           05  WS-NEW-BALANCE              PIC S9(9)V99.

       01  WS-FLAGS.
           05  WS-EOF-FLAG                 PIC X VALUE 'N'.
               88  WS-EOF                  VALUE 'Y'.
           05  WS-CUST-FOUND               PIC X VALUE 'N'.
               88  CUSTOMER-FOUND          VALUE 'Y'.
               88  CUSTOMER-NOT-FOUND      VALUE 'N'.

       01  WS-REPORT-HEADER.
           05  FILLER                      PIC X(40)
               VALUE 'TRANSACTION PROCESSING REPORT'.
           05  FILLER                      PIC X(20) VALUE SPACES.
           05  WS-RPT-DATE                 PIC X(10).
           05  FILLER                      PIC X(10) VALUE SPACES.
           05  FILLER                      PIC X(5) VALUE 'PAGE '.
           05  WS-RPT-PAGE                 PIC ZZZ9.

       PROCEDURE DIVISION.

       0000-MAIN SECTION.

       0000-START.
           PERFORM 1000-INITIALIZATION
           PERFORM 2000-PROCESS-TRANSACTIONS UNTIL WS-EOF
           PERFORM 8000-PRINT-TOTALS
           PERFORM 9000-TERMINATION
           STOP RUN.

       1000-INITIALIZATION SECTION.

       1000-INIT.
           INITIALIZE WS-TOTALS
           INITIALIZE WS-COUNTS
           INITIALIZE WS-WORK-FIELDS
           MOVE 0 TO RPT-PAGE-NUM
           MOVE 0 TO RPT-LINE-NUM
           MOVE 0 TO RPT-RECORD-COUNT
           MOVE 0 TO RPT-ERROR-COUNT
           OPEN INPUT TRANSACTION-FILE
           OPEN I-O CUSTOMER-FILE
           OPEN OUTPUT REPORT-FILE
           PERFORM 1100-READ-FIRST-TRAN.

       1100-READ-FIRST-TRAN.
           READ TRANSACTION-FILE INTO WS-WORK-TRANSACTION
               AT END SET WS-EOF TO TRUE
           END-READ.

       2000-PROCESS-TRANSACTIONS SECTION.

       2000-PROCESS.
           ADD 1 TO RPT-RECORD-COUNT
           EVALUATE TRUE
               WHEN TRAN-PAYMENT OF WS-WORK-TRANSACTION
                   PERFORM 3000-PROCESS-PAYMENT
               WHEN TRAN-PURCHASE OF WS-WORK-TRANSACTION
                   PERFORM 4000-PROCESS-PURCHASE
               WHEN TRAN-REFUND OF WS-WORK-TRANSACTION
                   PERFORM 5000-PROCESS-REFUND
               WHEN TRAN-ADJUSTMENT OF WS-WORK-TRANSACTION
                   PERFORM 6000-PROCESS-ADJUSTMENT
               WHEN OTHER
                   ADD 1 TO WS-ERROR-COUNT
                   ADD 1 TO RPT-ERROR-COUNT
           END-EVALUATE

           MOVE 'abcd' TO TRAN-CUSTOMER-ID
           MOVE '123' TO PAY-BANK-CODE
           
           PERFORM 2100-READ-NEXT-TRAN.

       2100-READ-NEXT-TRAN.
           READ TRANSACTION-FILE INTO WS-WORK-TRANSACTION
               AT END SET WS-EOF TO TRUE
           END-READ.

       3000-PROCESS-PAYMENT SECTION.

       3000-PAYMENT.
           ADD 1 TO WS-PAYMENT-COUNT
           MOVE TRAN-CUSTOMER-ID OF WS-WORK-TRANSACTION
               TO CUST-ID OF CUSTOMER-RECORD
           READ CUSTOMER-FILE INTO WS-WORK-CUSTOMER
           IF WS-CUST-STATUS = '00'
               SET CUSTOMER-FOUND TO TRUE
               PERFORM 3100-APPLY-PAYMENT
               PERFORM 3200-UPDATE-CUSTOMER
           ELSE
               SET CUSTOMER-NOT-FOUND TO TRUE
               ADD 1 TO WS-ERROR-COUNT
           END-IF.

       3100-APPLY-PAYMENT.
      *    Access payment-specific fields via REDEFINES
           MOVE PAY-METHOD OF WS-WORK-TRANSACTION
               TO WS-WORK-FIELDS
           MOVE PAY-REFERENCE OF WS-WORK-TRANSACTION
               TO WS-WORK-FIELDS
           COMPUTE WS-NEW-BALANCE =
               CUST-BALANCE OF WS-WORK-CUSTOMER -
               TRAN-AMOUNT OF WS-WORK-TRANSACTION
           MOVE WS-NEW-BALANCE TO CUST-BALANCE OF WS-WORK-CUSTOMER
           MOVE TRAN-AMOUNT OF WS-WORK-TRANSACTION
               TO CUST-LAST-PAYMENT OF WS-WORK-CUSTOMER
           MOVE TRAN-DATE OF WS-WORK-TRANSACTION
               TO CUST-PAYMENT-DATE OF WS-WORK-CUSTOMER
           ADD TRAN-AMOUNT OF WS-WORK-TRANSACTION
               TO WS-TOTAL-PAYMENTS.

       3200-UPDATE-CUSTOMER.
           REWRITE CUSTOMER-RECORD FROM WS-WORK-CUSTOMER.

       4000-PROCESS-PURCHASE SECTION.

       4000-PURCHASE.
           ADD 1 TO WS-PURCHASE-COUNT
           MOVE TRAN-CUSTOMER-ID OF WS-WORK-TRANSACTION
               TO CUST-ID OF CUSTOMER-RECORD
           READ CUSTOMER-FILE INTO WS-WORK-CUSTOMER
           IF WS-CUST-STATUS = '00'
               SET CUSTOMER-FOUND TO TRUE
               PERFORM 4100-CALCULATE-PURCHASE
               PERFORM 4200-UPDATE-BALANCE
           ELSE
               SET CUSTOMER-NOT-FOUND TO TRUE
               ADD 1 TO WS-ERROR-COUNT
           END-IF.

       4100-CALCULATE-PURCHASE.
      *    Access purchase-specific fields via REDEFINES
           MOVE PUR-SUBTOTAL OF WS-WORK-TRANSACTION
               TO WS-CALC-TOTAL
           ADD PUR-TAX-AMOUNT OF WS-WORK-TRANSACTION
               TO WS-CALC-TOTAL
           ADD PUR-SHIP-COST OF WS-WORK-TRANSACTION
               TO WS-CALC-TOTAL
           SUBTRACT PUR-DISCOUNT OF WS-WORK-TRANSACTION
               FROM WS-CALC-TOTAL
           ADD WS-CALC-TOTAL TO WS-TOTAL-PURCHASES.

       4200-UPDATE-BALANCE.
           ADD WS-CALC-TOTAL TO CUST-BALANCE OF WS-WORK-CUSTOMER
           REWRITE CUSTOMER-RECORD FROM WS-WORK-CUSTOMER.

       5000-PROCESS-REFUND SECTION.

       5000-REFUND.
           ADD 1 TO WS-REFUND-COUNT
           MOVE TRAN-CUSTOMER-ID OF WS-WORK-TRANSACTION
               TO CUST-ID OF CUSTOMER-RECORD
           READ CUSTOMER-FILE INTO WS-WORK-CUSTOMER
           IF WS-CUST-STATUS = '00'
               PERFORM 5100-APPLY-REFUND
           ELSE
               ADD 1 TO WS-ERROR-COUNT
           END-IF.

       5100-APPLY-REFUND.
      *    Access refund-specific fields via REDEFINES
           MOVE REF-ORIGINAL-TRAN OF WS-WORK-TRANSACTION
               TO RPT-RECORD-COUNT
           MOVE REF-REASON-CODE OF WS-WORK-TRANSACTION
               TO WS-WORK-FIELDS
           SUBTRACT TRAN-AMOUNT OF WS-WORK-TRANSACTION
               FROM CUST-BALANCE OF WS-WORK-CUSTOMER
           ADD TRAN-AMOUNT OF WS-WORK-TRANSACTION
               TO WS-TOTAL-REFUNDS
           REWRITE CUSTOMER-RECORD FROM WS-WORK-CUSTOMER.

       6000-PROCESS-ADJUSTMENT SECTION.

       6000-ADJUSTMENT.
           ADD 1 TO WS-ADJUSTMENT-COUNT
           MOVE TRAN-CUSTOMER-ID OF WS-WORK-TRANSACTION
               TO CUST-ID OF CUSTOMER-RECORD
           READ CUSTOMER-FILE INTO WS-WORK-CUSTOMER
           IF WS-CUST-STATUS = '00'
               ADD TRAN-AMOUNT OF WS-WORK-TRANSACTION
                   TO CUST-BALANCE OF WS-WORK-CUSTOMER
               ADD TRAN-AMOUNT OF WS-WORK-TRANSACTION
                   TO WS-TOTAL-ADJUSTMENTS
               REWRITE CUSTOMER-RECORD FROM WS-WORK-CUSTOMER
           ELSE
               ADD 1 TO WS-ERROR-COUNT
           END-IF.

       8000-PRINT-TOTALS SECTION.

       8000-TOTALS.
           ADD 1 TO RPT-PAGE-NUM
           MOVE RPT-PAGE-NUM TO WS-RPT-PAGE
           WRITE REPORT-LINE FROM WS-REPORT-HEADER
           MOVE WS-TOTAL-PAYMENTS TO RPT-AMT-NUMERIC
           STRING 'TOTAL PAYMENTS:    ' RPT-AMT-DISPLAY
               DELIMITED SIZE INTO REPORT-LINE
           WRITE REPORT-LINE
           MOVE WS-TOTAL-PURCHASES TO RPT-AMT-NUMERIC
           STRING 'TOTAL PURCHASES:   ' RPT-AMT-DISPLAY
               DELIMITED SIZE INTO REPORT-LINE
           WRITE REPORT-LINE
           MOVE WS-TOTAL-REFUNDS TO RPT-AMT-NUMERIC
           STRING 'TOTAL REFUNDS:     ' RPT-AMT-DISPLAY
               DELIMITED SIZE INTO REPORT-LINE
           WRITE REPORT-LINE.

       9000-TERMINATION SECTION.

       9000-TERM.
           CLOSE TRANSACTION-FILE
           CLOSE CUSTOMER-FILE
           CLOSE REPORT-FILE.
